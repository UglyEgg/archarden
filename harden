#!/usr/bin/env bash
set -euo pipefail

DRY_RUN=0
ENABLE_FAIL2BAN=1
ENABLE_UFW=1
SKIP_FIREWALL_ENABLE=0
KEEP_SSH_22=0
RESTRICT_SSH_CIDR=""
USER_NAME=""
PUBKEY_FILE=""
PUBKEY_VALUE=""
ENABLE_AUDITD=0
NON_INTERACTIVE=0
ENABLE_LINGER=0
SSH_PORT=1731
SSH_CONNECTION_INFO=""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="${SCRIPT_DIR}/config"
TEMPLATES_DIR="${SCRIPT_DIR}/templates"
source "${SCRIPT_DIR}/lib/utils.sh"

status_cmd() {
    local cmd="$*"
    log_info "Status: ${cmd}"
    eval "${cmd}"
}

usage() {
    cat <<USAGE
Usage: sudo ./harden [options]
  --user <name>            Create or ensure admin user exists and in wheel group.
  --pubkey-file <path>     Public key file to install for the admin user.
  --pubkey "<key>"         Public key string to install for the admin user.
  --ssh-port <port>        SSH port to configure (default: 2122).
  --restrict-ssh-cidr <C>  Restrict SSH via UFW to the given CIDR.
  --keep-ssh-22            Keep SSH port 22 allowed in UFW (transition).
  --enable-auditd          Install and enable auditd.
  --disable-fail2ban       Skip fail2ban configuration.
  --disable-ufw            Do not configure UFW at all.
  --skip-firewall-enable   Configure UFW rules but do not enable the firewall.
  --enable-linger          Enable lingering for the admin user (rootless containers).
  --dry-run                Show actions without changing the system.
  --non-interactive        Fail if required inputs are missing instead of prompting.
  -h, --help               Show this help.
USAGE
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --user) USER_NAME="$2"; shift 2;;
            --pubkey-file) PUBKEY_FILE="$2"; shift 2;;
            --pubkey) PUBKEY_VALUE="$2"; shift 2;;
            --ssh-port) SSH_PORT="$2"; shift 2;;
            --restrict-ssh-cidr) RESTRICT_SSH_CIDR="$2"; shift 2;;
            --keep-ssh-22) KEEP_SSH_22=1; shift;;
            --enable-auditd) ENABLE_AUDITD=1; shift;;
            --disable-fail2ban) ENABLE_FAIL2BAN=0; shift;;
            --disable-ufw) ENABLE_UFW=0; shift;;
            --skip-firewall-enable) SKIP_FIREWALL_ENABLE=1; shift;;
            --enable-linger) ENABLE_LINGER=1; shift;;
            --dry-run) DRY_RUN=1; shift;;
            --non-interactive) NON_INTERACTIVE=1; shift;;
            -h|--help) usage; exit 0;;
            *) log_error "Unknown option: $1"; usage; exit 1;;
        esac
    done
    export DRY_RUN
}

preflight() {
    require_root
    if ! grep -qi 'arch' /etc/os-release; then
        log_error "This tool is intended for Arch Linux systems."
        exit 1
    fi
    if [[ ${NON_INTERACTIVE} -eq 1 ]] && [[ -n "${USER_NAME}" ]] && [[ -z "${PUBKEY_FILE}" && -z "${PUBKEY_VALUE}" ]]; then
        log_error "--non-interactive requires --pubkey or --pubkey-file when creating a user."
        exit 1
    fi
    if ! [[ ${SSH_PORT} =~ ^[0-9]+$ ]] || (( SSH_PORT < 1 || SSH_PORT > 65535 )); then
        log_error "Invalid --ssh-port '${SSH_PORT}'. Must be 1-65535."
        exit 1
    fi
    if [[ -n "${SSH_CONNECTION:-}" ]]; then
        SSH_CONNECTION_INFO=${SSH_CONNECTION}
        log_info "Running under SSH from ${SSH_CONNECTION_INFO}"
    else
        log_warn "Not running under SSH; lockout protections limited."
    fi
}

install_packages() {
    local pkgs=(ufw openssh fail2ban pacman-contrib podman slirp4netns fuse-overlayfs netavark aardvark-dns)
    if [[ ${ENABLE_AUDITD} -eq 1 ]]; then
        pkgs+=(audit)
    fi
    log_info "Updating system and installing packages: ${pkgs[*]}"
    run_cmd "pacman -Syu --noconfirm ${pkgs[*]}"
}

enable_timesync() {
    run_cmd "systemctl enable --now systemd-timesyncd.service"
}

configure_journald() {
    backup_file /etc/systemd/journald.conf
    write_file_atomic /etc/systemd/journald.conf < "${CONFIG_DIR}/journald.conf"
    run_cmd "systemctl restart systemd-journald"
}

configure_sysctl() {
    backup_file /etc/sysctl.d/99-hardening.conf
    write_file_atomic /etc/sysctl.d/99-hardening.conf < "${CONFIG_DIR}/sysctl_hardening.conf"
    run_cmd "sysctl -p /etc/sysctl.d/99-hardening.conf"
}

configure_tmp_mount() {
    backup_file /etc/systemd/system/tmp.mount
    write_file_atomic /etc/systemd/system/tmp.mount < "${CONFIG_DIR}/tmp.mount"
    run_cmd "systemctl daemon-reload"
    run_cmd "systemctl enable --now tmp.mount"
}

report_services() {
    log_info "Enabled services summary:"
    status_cmd "systemctl list-unit-files --type=service --state=enabled"
}

detect_kex() {
    if command -v ssh >/dev/null 2>&1; then
        if ssh -Q kex 2>/dev/null | grep -q 'sntrup761x25519-sha512@openssh.com'; then
            echo "KexAlgorithms sntrup761x25519-sha512@openssh.com"
        fi
    fi
}

configure_sshd() {
    local sshd_dir=/etc/ssh/sshd_config.d
    mkdir -p "${sshd_dir}"
    run_cmd "ssh-keygen -A"
    local kex_line="$(detect_kex)"
    local dropin="${sshd_dir}/10-hardening.conf"
    backup_file "${dropin}"
    sed "s/__SSH_PORT__/${SSH_PORT}/g" "${CONFIG_DIR}/sshd_hardening.conf" | write_file_atomic "${dropin}"
    if [[ -n "${kex_line}" ]]; then
        append_if_missing "${dropin}" "${kex_line}"
    fi
    if [ "${DRY_RUN}" -eq 0 ]; then
        if ! sshd -t; then
            log_error "sshd configuration failed validation"
            exit 1
        fi
    else
        log_info "[DRY-RUN] Skipping sshd validation"
    fi
}

restart_sshd_and_verify() {
    if [ "${DRY_RUN}" -eq 0 ]; then
        run_cmd "systemctl restart sshd"
        if ! ss -tulpn | grep -q ":${SSH_PORT}"; then
            log_error "sshd is not listening on port ${SSH_PORT} after restart"
            exit 1
        fi
    else
        log_info "[DRY-RUN] Would restart sshd and verify port ${SSH_PORT}"
    fi
}

create_admin_user() {
    if [[ -z "${USER_NAME}" ]]; then
        return
    fi
    if id -u "${USER_NAME}" >/dev/null 2>&1; then
        log_info "User ${USER_NAME} already exists"
    else
        run_cmd "useradd -m -G wheel -s /bin/bash ${USER_NAME}"
        log_info "Created user ${USER_NAME} and added to wheel"
    fi
    if [[ ${ENABLE_LINGER} -eq 1 ]]; then
        run_cmd "loginctl enable-linger ${USER_NAME}"
    fi
    if [[ -n "${PUBKEY_FILE}" ]]; then
        PUBKEY_VALUE=$(cat "${PUBKEY_FILE}")
    fi
    if [[ -n "${PUBKEY_VALUE}" ]]; then
        local ssh_dir="/home/${USER_NAME}/.ssh"
        run_cmd "install -d -m 700 -o ${USER_NAME} -g ${USER_NAME} ${ssh_dir}"
        local auth_keys="${ssh_dir}/authorized_keys"
        if [ "${DRY_RUN}" -eq 0 ]; then
            if [ ! -f "${auth_keys}" ]; then
                touch "${auth_keys}"
                chown "${USER_NAME}:${USER_NAME}" "${auth_keys}"
                chmod 600 "${auth_keys}"
            fi
            if ! grep -qxF "${PUBKEY_VALUE}" "${auth_keys}"; then
                echo "${PUBKEY_VALUE}" >>"${auth_keys}"
            fi
        else
            log_info "[DRY-RUN] Would add key for ${USER_NAME}"
        fi
    else
        log_warn "No public key provided for ${USER_NAME}; ensure key-based auth manually."
    fi
}

configure_ufw() {
    if [[ ${ENABLE_UFW} -eq 0 ]]; then
        log_warn "UFW configuration disabled by flag"
        return
    fi
    backup_file /etc/default/ufw
    run_cmd "sed -i 's/^IPV6=.*/IPV6=yes/' /etc/default/ufw || echo 'IPV6=yes' >> /etc/default/ufw"
    run_cmd "ufw --force reset"
    run_cmd "ufw default deny incoming"
    run_cmd "ufw default allow outgoing"

    if [[ -n "${RESTRICT_SSH_CIDR}" ]]; then
        run_cmd "ufw allow from ${RESTRICT_SSH_CIDR} to any port ${SSH_PORT} proto tcp"
    else
        run_cmd "ufw limit ${SSH_PORT}/tcp"
    fi

    if ss -tulpn 2>/dev/null | grep -q ':22'; then
        run_cmd "ufw allow 22/tcp"
    fi
    if [[ ${KEEP_SSH_22} -eq 1 ]]; then
        run_cmd "ufw allow 22/tcp"
    fi

    run_cmd "ufw allow 80/tcp"
    run_cmd "ufw allow 443/tcp"

    if [[ ${SKIP_FIREWALL_ENABLE} -eq 1 ]]; then
        log_warn "Skipping firewall enable as requested"
    else
        run_cmd "ufw --force enable"
        if [[ ${KEEP_SSH_22} -eq 0 ]]; then
            if [ "${DRY_RUN}" -eq 0 ]; then
                ufw delete allow 22/tcp >/dev/null 2>&1 || true
            else
                log_info "[DRY-RUN] Would remove legacy SSH port 22 rule"
            fi
        fi
    fi
    run_cmd "ufw reload"
}

configure_fail2ban() {
    if [[ ${ENABLE_FAIL2BAN} -eq 0 ]]; then
        log_warn "Fail2ban disabled by flag"
        return
    fi
    backup_file /etc/fail2ban/jail.local
    sed "s/__SSH_PORT__/${SSH_PORT}/g" "${CONFIG_DIR}/fail2ban_jail.local" | write_file_atomic /etc/fail2ban/jail.local
    run_cmd "systemctl enable --now fail2ban.service"
    if [ "${DRY_RUN}" -eq 0 ]; then
        status_cmd "fail2ban-client status sshd || true"
    fi
}

configure_podman_templates() {
    local dest_dir=/usr/share/vps-harden/templates/containers
    write_file_atomic /usr/share/vps-harden/README <<'EOT'
Podman templates installed by vps-harden.
EOT
    write_file_atomic "${dest_dir}/nginx-proxy-manager.container" < "${TEMPLATES_DIR}/containers/nginx-proxy-manager.container"
    write_file_atomic "${dest_dir}/podman-run-npm.sh" < "${TEMPLATES_DIR}/containers/podman-run-npm.sh"
    run_cmd "chmod +x ${dest_dir}/podman-run-npm.sh"
}

status_report() {
    log_info "==== STATUS REPORT ===="
    status_cmd "ss -tulnp || true"
    if command -v ufw >/dev/null 2>&1; then
        status_cmd "ufw status verbose || true"
    fi
    if systemctl list-unit-files --type=service | grep -q fail2ban.service; then
        status_cmd "systemctl status fail2ban --no-pager || true"
    fi
    report_services
    if [[ ${#BACKUP_PATHS[@]} -gt 0 ]]; then
        log_info "Backups created: ${BACKUP_PATHS[*]}"
    fi
}

main() {
    parse_args "$@"
    preflight
    install_packages
    enable_timesync
    configure_journald
    configure_sysctl
    configure_tmp_mount
    create_admin_user
    configure_sshd
    restart_sshd_and_verify
    configure_ufw
    configure_fail2ban
    configure_podman_templates
    status_report
    log_info "Hardening completed. Review status above before logging out."
}

main "$@"
