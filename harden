#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# Copyright (c) 2025 Richard Majewski
# shellcheck disable=SC2034  # globals are shared with sourced libs and steps
set -eEuo pipefail

declare -g \
    PHASE0_LOG="/var/log/vps-harden.phase0.log" \
    PHASE1_LOG="/var/log/vps-harden.phase1.log" \
    LOG_FILE="/var/log/vps-harden.phase0.log" \
    CURRENT_PHASE="phase0" \
    CURRENT_STEP="" \
    SSHD_CONFIG_DIR="/etc/ssh/sshd_config.d" \
    SSHD_HARDENING_DROPIN="/etc/ssh/sshd_config.d/10-hardening.conf" \
    SSHD_CRYPTO_DROPIN="/etc/ssh/sshd_config.d/10-crypto-hardening.conf" \
    SSHD_PORT_FORWARDING_DROPIN="/etc/ssh/sshd_config.d/20-portforwarding.conf" \
    BACKUP_ROOT_BASE="/root/archarden-backups" \
    SSH_HOSTKEY_BACKUP_CATEGORY="ssh-hostkeys" \
    DEFAULT_INSTALL_PREFIX="/usr/local/lib/vps-harden" \
    DRY_RUN=0 \
    ENABLE_FAIL2BAN=1 \
    ENABLE_FIREWALL=1 \
    SKIP_FIREWALL_ENABLE=0 \
    KEEP_SSH_22=0 \
    RESTRICT_SSH_CIDR="" \
    USER_NAME="" \
    USER_HOME="" \
    PODMAN_USER="podmin" \
    PODMAN_HOME="" \
    PODMAN_UID="" \
    ENSURED_PODMIN_MANAGER=0 \
    PODMAN_PREREQS_READY=1 \
    PODMAN_PREREQ_REASON="" \
    PUBKEY_FILE="" \
    PUBKEY_VALUE="" \
    ENABLE_AUDITD=0 \
    SYSTEM_HOSTNAME="" \
    SSH_PORT=2122 \
    SSH_CONNECTION_INFO="" \
    GRUB_LTS_ENTRY="Advanced options for Arch Linux>Arch Linux, with Linux linux-lts" \
    GRUB_CONFIG_PATH="/boot/grub/grub.cfg" \
    INSTALL_PREFIX="/usr/local/lib/vps-harden" \
    INSTALL_BIN="/usr/local/bin/vps-harden" \
    STATE_DIR="/var/lib/vps-harden" \
    PENDING_ARGS_FILE="/var/lib/vps-harden/pending_args" \
    PERSISTED_PUBKEY_FILE="/var/lib/vps-harden/pubkey" \
    RUN_ID_FILE="/var/lib/vps-harden/run_id" \
    CONTINUE_SERVICE="/etc/systemd/system/vps-harden-continue.service" \
    CONTINUE_SERVICE_TEMPLATE="" \
    FINAL_LOG_FILE="" \
    RUN_ID="" \
    BACKUP_ROOT="" \
    BACKUP_ARCHIVE="" \
    README_MARKER="<!-- managed: archarden -->" \
    GOTIFY_PORT=9090 \
    WG_INTERFACE_ADDRESS="" \
    WG_LISTEN_PORT="" \
    WG_DNS="" \
    WIREGUARD_CONFIG_LOADED=0 \
    WIREGUARD_SERVER_IP="" \
    WIREGUARD_SERVER_ALLOWED_IP="" \
    PODMAN_API_GROUP="podman-api"
# shellcheck disable=SC2034  # shared arrays used across sourced libs and steps
declare -g -a \
    INVOCATION_ARGS=() \
    WG_PEERS=() \
    WIREGUARD_PEER_NAMES=() \
    WIREGUARD_PEER_IPS=() \
    ONLY_STEPS=() \
    SKIP_STEPS=()
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
if [[ ! -f "${SCRIPT_DIR}/lib/loader.sh" ]]; then
    FALLBACK_DIR="${DEFAULT_INSTALL_PREFIX}"
    if [[ -f "${FALLBACK_DIR}/lib/loader.sh" ]]; then
        SCRIPT_DIR="${FALLBACK_DIR}"
    else
        printf 'Required helper not found: %s\n' "${SCRIPT_DIR}/lib/loader.sh" >&2
        exit 1
    fi
fi
# shellcheck disable=SC2034  # shared globals used across sourced libs and steps
CONFIG_DIR="${SCRIPT_DIR}/config"
TEMPLATES_DIR="${SCRIPT_DIR}/templates"
# shellcheck source=lib/loader.sh disable=SC1091
source "${SCRIPT_DIR}/lib/loader.sh"
source_libs
# shellcheck source=lib/runner.sh disable=SC1091
source "${SCRIPT_DIR}/lib/runner.sh"
# shellcheck source=lib/steps.sh disable=SC1091
source "${SCRIPT_DIR}/lib/steps.sh"

CONTINUE_SERVICE_TEMPLATE="${TEMPLATES_DIR}/systemd/vps-harden-continue.service"

PHASE0_STEPS=(
    preflight
    initialize_run_context
    install_self
    clear_pending_state
    ensure_lts_kernel_and_reboot_gate
)

PHASE1_STEPS=(
    switch_to_phase1_logging
    verify_nf_tables_after_reboot
    install_packages
    enable_timesync
    configure_journald
    configure_sysctl
    configure_vm_tuning_sysctl
    apply_sysctl_settings
    configure_tmp_mount
    configure_zram
    configure_hostname
    ensure_ssh_group
    create_admin_user
    ensure_podmin_user
    configure_podman_runtime
    ensure_rootless_podman_prereqs
    configure_sshd
    restart_sshd_and_verify
    rotate_sshd_host_keys
    configure_wireguard
    configure_ufw
    configure_fail2ban
    configure_podman_templates
    configure_rootless_quadlets
    configure_podman_api_proxy
    configure_socket_proxyd
    configure_gotify_notifications
    verify_podman_runtime
    verify_zram_swap
    ensure_default_target
    disable_units_from_config
    status_report
    final_container_checks
    final_summary
    write_user_readme
    archive_backups
    trigger_final_reboot
)

set_phase_from_args() {
    local arg
    CURRENT_PHASE="phase0"
    LOG_FILE="${PHASE0_LOG}"
    for arg in "$@"; do
        if [[ "${arg}" == "--resume" ]]; then
            CURRENT_PHASE="phase1"
            LOG_FILE="${PHASE1_LOG}"
            break
        fi
    done
    export LOG_FILE
}

resume_needs_restore() {
    local arg resume_present=0
    for arg in "$@"; do
        if [[ "${arg}" == "--resume" ]]; then
            resume_present=1
            break
        fi
    done
    if [[ ${resume_present} -eq 1 && $# -eq 1 ]]; then
        return 0
    fi
    return 1
}

show_version() {
    local version_file="${SCRIPT_DIR}/VERSION"
    if [[ -f "${version_file}" ]]; then
        cat "${version_file}"
    else
        echo "unknown"
    fi
}

usage() {
    printf "%s\n" "$(bold "Usage:") $(cyan "sudo ./harden [options]")"
    printf "\n%s\n" "$(bold "$(green "Required")")"
    printf "  %s\n" "$(cyan "--hostname <name>")          Set the system hostname."
    printf "  %s\n" "$(cyan "--user <name>")              Create or ensure admin user exists and in wheel group."
    printf "  %s\n" "$(cyan "--pubkey-file <path>")       Public key file to install for the admin user."
    printf "  %s\n" "$(cyan "--pubkey \"<key>\"")           Public key string to install for the admin user."

    printf "\n%s\n" "$(bold "$(green "SSH")")"
    printf "  %s\n" "$(cyan "--ssh-port <port>")          SSH port to configure (default: 2122)."
    printf "  %s\n" "$(cyan "--restrict-ssh-cidr <C>")    Restrict SSH via UFW to the given CIDR."
    printf "  %s\n" "$(cyan "--keep-ssh-22")              Keep port 22 allowed (transition)."

    printf "\n%s\n" "$(bold "$(green "Optional services")")"
    printf "  %s\n" "$(cyan "--enable-auditd")            Install and enable auditd."
    printf "  %s\n" "$(cyan "--disable-fail2ban")         Skip fail2ban configuration."
    printf "  %s\n" "$(cyan "--disable-firewall")         Skip firewall configuration (alias: --disable-ufw)."
    printf "  %s\n" "$(cyan "--skip-firewall-enable")     Write UFW rules but do not enable the firewall."

    printf "\n%s\n" "$(bold "$(green "Behavior")")"
    printf "  %s\n" "$(cyan "--only <steps>")             Comma-separated step list to run (phase-aware)."
    printf "  %s\n" "$(cyan "--skip <steps>")             Comma-separated step list to skip (phase-aware)."
    printf "  %s\n" "$(cyan "--dry-run")                  Show actions without changing the system."
    printf "  %s\n" "$(cyan "--resume")                   Internal flag: resume after reboot; do not re-arm continuation."
    printf "  %s\n" "$(cyan "--version")                  Show version and exit."
    printf "  %s\n" "$(cyan "-h, --help")                 Show this help."
}

parse_step_filters() {
    local value="$1"; shift
    local -n target=$1
    target=()
    IFS=',' read -r -a target <<<"${value}"
    local idx
    for idx in "${!target[@]}"; do
        target[idx]="${target[idx]//[[:space:]]/}"
    done
}

parse_args() {
    RESUME_MODE=0
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --hostname) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                SYSTEM_HOSTNAME="$2"; shift 2;;
            --user) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                USER_NAME="$2"; shift 2;;
            --pubkey-file) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                PUBKEY_FILE="$2"; shift 2;;
            --pubkey) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                PUBKEY_VALUE="$2"; shift 2;;
            --version) show_version; exit 0;;
            --ssh-port) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                SSH_PORT="$2"; shift 2;;
            --restrict-ssh-cidr) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                RESTRICT_SSH_CIDR="$2"; shift 2;;
            --keep-ssh-22) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                KEEP_SSH_22=1; shift;;
            --enable-auditd) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                ENABLE_AUDITD=1; shift;;
            --disable-fail2ban) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                ENABLE_FAIL2BAN=0; shift;;
            --disable-firewall|--disable-ufw) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                ENABLE_FIREWALL=0; shift;;
            --skip-firewall-enable) # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
                SKIP_FIREWALL_ENABLE=1; shift;;
            --only) parse_step_filters "$2" ONLY_STEPS; shift 2;;
            --skip) parse_step_filters "$2" SKIP_STEPS; shift 2;;
            --dry-run) DRY_RUN=1; shift;;
            --resume) RESUME_MODE=1; shift;;
            -h|--help) usage; exit 0;;
            *) log_error "Unknown option: $1"; usage; exit 1;;
        esac
    done
    export DRY_RUN
}

validate_step_filters() {
    local -a all_steps=("${PHASE0_STEPS[@]}" "${PHASE1_STEPS[@]}")
    local step
    for step in "${ONLY_STEPS[@]}"; do
        if [[ -n "${step}" ]] && ! step_in_list "${step}" "${all_steps[@]}"; then
            log_warn "Requested --only step '${step}' not found in any phase"
        fi
    done
    for step in "${SKIP_STEPS[@]}"; do
        if [[ -n "${step}" ]] && ! step_in_list "${step}" "${all_steps[@]}"; then
            log_warn "Requested --skip step '${step}' not found in any phase"
        fi
    done
}

main() {
    local answer_file="${SCRIPT_DIR}/harden.params" file_args cli_args cli_has_dry_run=0 file_has_dry_run=0

    cli_args=("$@")

    if [[ "$#" -gt 0 && "$1" == "--resume" ]]; then
        :
    elif [[ -f "${answer_file}" ]]; then
        file_args=$(sed -e 's/[[:space:]]*#.*$//' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' "${answer_file}" | tr '\n' ' ')
        if [[ -n "${file_args//[[:space:]]/}" ]]; then
            if [[ " ${file_args} " == *" --dry-run "* ]]; then
                file_has_dry_run=1
            fi
            eval "set -- ${file_args}"
            set_phase_from_args "$@"
            log_info "Using parameter file ${answer_file}; overriding CLI arguments"
        else
            set --
        fi
    fi

    for arg in "${cli_args[@]}"; do
        if [[ "${arg}" == "--dry-run" ]]; then
            cli_has_dry_run=1
            break
        fi
    done
    if [[ ${cli_has_dry_run} -eq 1 && ${file_has_dry_run} -eq 0 ]]; then
        set -- "$@" --dry-run
    fi

    if resume_needs_restore "$@"; then
        if [[ ! -s "${PENDING_ARGS_FILE}" ]]; then
            log_error "Resume requested but pending args missing at ${PENDING_ARGS_FILE}"
            exit 1
        fi
        local saved_args
        saved_args=$(cat "${PENDING_ARGS_FILE}")
        eval "set -- --resume ${saved_args}"
        set_phase_from_args "$@"
        log_info "Resume requested without parameters; restoring saved arguments from ${PENDING_ARGS_FILE}"
    else
        set_phase_from_args "$@"
    fi

    parse_args "$@"
    # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
    INVOCATION_ARGS=("$@")
    validate_step_filters

    if [[ ${RESUME_MODE} -eq 0 ]]; then
        run_steps "phase0" PHASE0_STEPS
    else
        # shellcheck disable=SC2034  # shared globals used across sourced libs and steps
        CURRENT_PHASE="phase1"
        LOG_FILE="${PHASE1_LOG}"
        export LOG_FILE
    fi

    run_steps "phase1" PHASE1_STEPS
}

main "$@"
